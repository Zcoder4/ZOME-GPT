<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Chat Pro - Red & Black</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        #chat-box::-webkit-scrollbar { width: 4px; }
        #chat-box::-webkit-scrollbar-track { background: #1a1a1a; }
        #chat-box::-webkit-scrollbar-thumb { background: #ff0000; border-radius: 10px; }
        .h-screen-safe { height: 100vh; height: calc(var(--vh, 1vh) * 100); }
        
        /* Markdown Styling */
        .prose pre { background: #000 !important; padding: 10px; border: 1px solid #333; border-radius: 8px; overflow-x: auto; }
        .prose code { color: #ff4444; font-family: monospace; }
        .prose p { margin-bottom: 8px; }
    </style>
</head>
<body class="bg-[#0a0a0a]">

<div class="flex flex-col max-w-5xl mx-auto bg-[#111111] h-screen-safe md:h-[95vh] md:my-[2.5vh] md:border md:border-red-900 md:rounded-xl overflow-hidden shadow-2xl">
    
    <header class="bg-black border-b border-red-600 p-4 text-white flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 border-2 border-red-600 rounded-full flex items-center justify-center font-bold text-red-600"></div>
            <h1 class="font-bold tracking-wider uppercase text-red-600">ZOME-GPT</h1>
        </div>
        <button onclick="clearChat()" class="text-xs bg-red-900/30 hover:bg-red-600 text-red-500 hover:text-white px-3 py-1 rounded transition-all border border-red-900">Hapus Riwayat</button>
    </header>

    <div id="chat-box" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 bg-black"></div>

    <div class="p-4 bg-black border-t border-red-900">
        <div class="flex items-end gap-3 max-w-4xl mx-auto">
            <textarea id="user-input" rows="1" placeholder="Ketik pesan..." class="flex-1 bg-[#1a1a1a] text-white border border-red-900 focus:border-red-600 rounded-xl py-3 px-4 outline-none resize-none"></textarea>
            <button id="send-btn" class="bg-red-600 hover:bg-red-700 text-white p-3.5 rounded-xl shadow-[0_0_15px_rgba(255,0,0,0.3)]">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
            </button>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    // Initialize LocalStorage
    let chatHistory = JSON.parse(localStorage.getItem('ai_chat_history')) || [];

    // Render history on load
    window.onload = () => {
        chatHistory.forEach(msg => appendToUI(msg.content, msg.role));
        setVh();
    };

    function setVh() { document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); }
    window.addEventListener('resize', setVh);

    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        saveAndRender(text, 'user');
        userInput.value = '';
        userInput.style.height = 'auto';
        sendBtn.disabled = true;

        const loadingId = 'ai-' + Date.now();
        appendToUI('Berpikir...', 'ai', loadingId);

        try {
            // Gunakan Default Prompt yang Aman
            const api = `https://api.siputzx.my.id/api/ai/gpt3?prompt=You%20are%20a%20helpful%20assistant%and%you%talking%indonesian%language&content=${encodeURIComponent(text)}`;
            const response = await fetch(api);
            const res = await response.json();
            
            const content = res.data || res.result || "Sistem tidak merespon.";
            
            document.getElementById(loadingId).innerHTML = marked.parse(content);
            document.querySelectorAll('pre code').forEach((el) => hljs.highlightElement(el));
            
            saveToHistory(content, 'ai');
        } catch (e) {
            document.getElementById(loadingId).innerText = "ERROR: Koneksi terputus.";
        } finally {
            sendBtn.disabled = false;
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }
    }

    function saveAndRender(content, role) {
        saveToHistory(content, role);
        appendToUI(content, role);
    }

    function saveToHistory(content, role) {
        chatHistory.push({ content, role });
        localStorage.setItem('ai_chat_history', JSON.stringify(chatHistory));
    }

    function appendToUI(content, role, id = null) {
        const wrapper = document.createElement('div');
        wrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
        
        const bubble = document.createElement('div');
        if(id) bubble.id = id;
        
        bubble.className = role === 'user' 
            ? "bg-red-600 text-white p-4 rounded-xl rounded-tr-none max-w-[90%] shadow-lg text-sm md:text-base font-medium"
            : "bg-[#1a1a1a] border-l-4 border-red-600 text-white p-4 rounded-r-xl max-w-[90%] prose prose-invert text-sm md:text-base";
        
        bubble.innerHTML = role === 'user' ? content : marked.parse(content);
        wrapper.appendChild(bubble);
        chatBox.appendChild(wrapper);
        
        if (role === 'ai') {
            wrapper.querySelectorAll('pre code').forEach((el) => hljs.highlightElement(el));
        }
        
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
    }

    function clearChat() {
        localStorage.removeItem('ai_chat_history');
        chatHistory = [];
        chatBox.innerHTML = '';
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>

</body>
</html>
